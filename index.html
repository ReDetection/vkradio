<html>
<head>
	<meta charset="UTF-8">
	<script type="text/javascript" src="http://vkontakte.ru/js/api/openapi.js" charset="windows-1251"></script>
	<script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.2.8.min.js"></script>
</head>
<body>

	<!-- TODO activity indicator -->


	<div id="indexpage">
		<h1 style="align: center;">Радио ВКонтакте</h1>

		<h4>Искать радиостанцию:</h4>
		<form action="/" method="post" onsubmit="return searchRadio(this[searchText].value);">
			<input type="text" name="searchText" id="searchText" />
			<input type="submit" value="Искать" />
		</form>

		<br>

		<div id="vklogin" style="display: none;">
			Для вещания нужно авторизоваться ВКонтакте<br>
			<div id="login_button" onclick="VK.Auth.login(authInfo, 8);"></div>
		</div>
		
		<div id="createbox" style="display: none;">
			<h4>Для создания радиостанции введите музыкальный поисковый запрос: </h4>
			<form action="/" method="post" onsubmit="createRadio(this); return false;">
				<input type="text" name="musicsearch" />
				<input type="submit" value="Искать" />
			</form>
		</div>

	</div>

	<div id="mainpage" style="display: none;">
		<h2><div id="statusLabel">Вы слушаете/вещаете радио БЛАБЛА</div></h2>
		Просто дайте слушателям эту ссылку: <input type="text" id="link" size="50" onClick="this.select();" /> 

		<div id="player"></div><br>

		<section id="results" style="display: none;">

      <form action="/" method="post" onsubmit="return musicSearch(this['musicsearch'].value);">
        <input type="text" name="musicsearch" id="mainpageSearchbox" />
        <input type="submit" value="Искать" />
      </form><br>

			Результаты:
			<div id="resultslist">
			</div>
		</section>

	</div>


	<script type="text/javascript">
		Parse.initialize("poVULgqVbzdhjQCip2OqubuwmuyZHJHgkrYCmNAd", "FtNJgAjrsbPzLSuPP6BmQflqx17doGz1A4HhGVqP");
		VK.init({
			apiId: 2810295,
			nameTransportPath: "xd_receiver.html"
		});

    var RadioClass = Parse.Object.extend("Radio");
    var radioInstance;
    var nowPlaying = "";
    var radioid = window.location.search.substring(1).split("/")[0];

    if(radioid && radioid.length==10){
      document.getElementById("searchText").value=radioid;
      searchRadio(radioid);
    } 

    VK.Auth.getLoginStatus(authInfo);
  
		function authInfo(response) {
			if (response.session) {
				VK.Api.call('getUserSettings', {}, allowedSettings);
			} else {
				VK.UI.button('login_button');
				show("vklogin");
			}
		}

		function allowedSettings(response){
			if ((parseInt(response.response) & 8) > 0){
				hide("vklogin");
				show("createbox");
			} else {
				VK.UI.button('login_button');
				show("vklogin");
			}
		}

    function searchRadio(queryString){
      var query = new Parse.Query(RadioClass);
      query.get(queryString,{
        success: function(instance) {
          radioInstance = instance;
          
          hide("indexpage");
          document.getElementById("statusLabel").innerHTML="Вы слушаете радио " + instance.id;
          document.getElementById("link").value="http://redetection.github.io/vkradio/?" + instance.id;
          show("mainpage");

          renewPlayer();
        },
        error: function(object, error) {
           document.getElementById("searchText").value="";
        }
      });

      return false;
    }

    function renewPlayer(){
      radioInstance.fetch({
        success: function(instance) {
          var track = instance.get("track");
          if (track.localeCompare(nowPlaying)!=0){
             justListen(track);
          }
        }
      });

      setTimeout(renewPlayer,10000);
    }

		function createRadio(form){
			hide("indexpage");
      var searchQuery = form["musicsearch"].value;
			musicSearch(searchQuery);
			var status = document.getElementById("statusLabel");
			status.innerHTML="Вы вещаете радио ";
      document.getElementById("mainpageSearchbox").value = searchQuery;
			show("mainpage");
			
			radioInstance = new RadioClass();
			radioInstance.save({author: VK.Auth.getSession().mid}, {
				success: function(object) {
				  status.innerHTML = status.innerHTML + object.id;
          document.getElementById("link").value="http://vkradio.github.io/?" + object.id;
				}
			});

			return false;
		}

		function musicSearch(query){
			hide("results");
			VK.Api.call('audio.search', {q: query, sort: 2}, function(r) {
				if(r.response) {
					var newHTML = "<table border='0'>";
					var len = r.response.length;
					for (var i=1; i<len; i++) {
				    var s = r.response[i];
				    
					  newHTML=newHTML+"<tr><td><b>" + s.artist + "</b> — " + s.title;
					  newHTML=newHTML+'&nbsp;<a id="listen" href="/" onclick="return justListen(\'' + trim(s.owner_id + '_' + s.aid) + '\');">Слушать</a>';
					  newHTML=newHTML+'&nbsp;<a id="shout" href="/" onclick="return shout(\'' + trim(s.owner_id + '_' + s.aid) + '\');">Вещать</a>';
					  newHTML=newHTML+" </td></tr>";
					}
					newHTML=newHTML+" </table>";

					var div = document.getElementById('resultslist');
					div.innerHTML=newHTML;
					show("results");

				} else {
					console.log(r);
				}
			});
      return false;
		}

		function justListen(track){
			var playerdiv = document.getElementById('player');
			playerdiv.innerHTML = "<iframe src='http://player.vas3k.ru/small/#track:"+ track + "' width=630 height=130></iframe>";
      nowPlaying = track;
			return false;
		}

		function shout(track){
			justListen(track);
			radioInstance.save({track: track},{});
			return false;
		}

		function trim(str) {
		    return str.replace(/^\s\s*/, '').replace(/\s\s*$/, '');
		}
		function show(id){
			document.getElementById(id).style.display = 'inline';
		}
		function hide(id){
			document.getElementById(id).style.display = 'none';
		}

</script>

<!-- TODO yandex metrics -->

</body>
</html>
