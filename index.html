<html>
<head>
	<meta charset="UTF-8">
	<script type="text/javascript" src="http://vkontakte.ru/js/api/openapi.js" charset="windows-1251"></script>
	<script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.2.8.min.js"></script>
</head>
<body>

	<!-- TODO activity indicator -->


	<div id="indexpage">
		<h1 style="align: center;">Радио ВКонтакте</h1>

		<h4>Искать радиостанцию:</h4>
		<form action="/" method="post" onsubmit="return searchFor(this);">
			<input type="text" name="searchText" id="searchText" />
			<input type="submit" value="Искать" />
		</form>

		<br>

		<div id="vklogin" style="display: none;">
			Для вещания нужно авторизоваться ВКонтакте<br>
			<div id="login_button" onclick="VK.Auth.login(authInfo, 8);"></div>
		</div>
		
		<div id="createbox" style="display: none;">
			<h4>Для создания радиостанции введите музыкальный поисковый запрос: </h4>
			<form action="/" method="post" onsubmit="return createRadio(this);">
				<input type="text" name="musicsearch" id="musicsearch" />
				<input type="submit" value="Искать" />
			</form>
		</div>

	</div>

	<div id="mainpage" style="display: none;">
		<div id="statusLabel"><h2>Вы слушаете/вещаете радио БЛАБЛА</h2></div>
		<!-- Просто дайте слушателям эту ссылку: <input type="text" id="link" /> -->

		<div id="player"></div><br>

		<section id="results" style="display: none;">
			Результаты:
			<div id="resultslist">
			</div>
		</section>

	</div>


	<script type="text/javascript">
		Parse.initialize("poVULgqVbzdhjQCip2OqubuwmuyZHJHgkrYCmNAd", "FtNJgAjrsbPzLSuPP6BmQflqx17doGz1A4HhGVqP");
		VK.init({
			apiId: 2810295,
			nameTransportPath: "xd_receiver.html"
		});
		VK.Auth.getLoginStatus(authInfo);
		// var radioid = window.location.search.substring(1);

		function searchFor(form){

			return false;
		}

		function authInfo(response) {
			if (response.session) {
				VK.Api.call('getUserSettings', {}, allowedSettings);
			} else {
				VK.UI.button('login_button');
				show("vklogin");
			}
		}

		function allowedSettings(response){
			if ((parseInt(response.response) & 8) > 0){
				hide("vklogin");
				show("createbox");
			} else {
				VK.UI.button('login_button');
				show("vklogin");
			}

		}

		function createRadio(form){
			hide("indexpage");
			musicSearch(form["musicsearch"].value);
			show("mainpage");
			// TODO parse.com
			return false;
		}

		function musicSearch(query){
			hide("results");
			VK.Api.call('audio.search', {q: query, sort: 2}, function(r) {
				if(r.response) {
					var newHTML = "<table border='0'>";
					var len = r.response.length;
					for (var i=1; i<len; i++) {
				    var s = r.response[i];
				    console.log(s.owner_id);
				    
					  newHTML=newHTML+"<tr><td><b>" + s.artist + "</b> — " + s.title;
					  newHTML=newHTML+'&nbsp;<a id="listen" href="/" onclick="return justListen(\'' + trim(s.owner_id + '_' + s.aid) + '\');">Слушать</a>';
					  newHTML=newHTML+'&nbsp;<a id="shout" href="/" onclick="return shout(\'' + trim(s.owner_id + '_' + s.aid) + '\');">Вещать</a>';
					  newHTML=newHTML+" </td></tr>";
					}
					newHTML=newHTML+" </table>";

					var div = document.getElementById('resultslist');
					div.innerHTML=newHTML;
					show("results");

				} else {
					console.log(r);
				}
			});

		}

		function justListen(track){
			console.log(track);
			var playerdiv = document.getElementById('player');
			playerdiv.innerHTML = "<iframe src='http://player.vas3k.ru/small/#track:"+ track + "' width=630 height=130></iframe>";
			return false;
		}

		function shout(track){
			justListen(track);
			// TODO send to parse.com
			return false;
		}

		function trim(str) {
		    return str.replace(/^\s\s*/, '').replace(/\s\s*$/, '');
		}

		function show(id){
			document.getElementById(id).style.display = 'inline';
		}
		function hide(id){
			document.getElementById(id).style.display = 'none';
		}

		// var TestObject = Parse.Object.extend("TestObject");
		// var testObject = new TestObject();
		// testObject.save({foo: "bar"}, {
		// 	success: function(object) {
		// 	  alert("yay! it worked");
		// 	}
		// });

</script>

<!-- TODO yandex metrics -->

</body>
</html>
